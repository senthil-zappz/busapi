version: 2.1
orbs:
  docker: circleci/docker@2.1.4
  heroku: circleci/heroku@2.0.0
jobs:
  build:
    docker:
      - image: cimg/openjdk:17.0
      - image: circleci/postgres
      environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
          POSTGRES_PASSWORD: 
    working_directory: ~/setup
    steps:
      - checkout
      - run: rm busservices.sql || true
      - run: rm busservices-v1.sql || true
      - run: curl https://www.phpix.com/myNextBus/busservices-v1.sql --output busservices-v1.sql
      - run: sudo apt-get update && sudo apt-get install postgresql-client
      - run: psql -h 127.0.0.1 -U postgres  -c "create database busservices;"
      - run: psql -h 127.0.0.1 -U postgres busservices < ~/setup/busservices-v1.sql
      - run: mvn -B -DskipTests clean package

  test:
    docker:
      - image: cimg/openjdk:17.0
    steps:
      - checkout
      - run: mvn test

  build-and-push:
    executor: docker/docker
    steps:
      - setup_remote_docker
      - checkout
      - docker/check
      - docker/build:
          image: senzen/busservices
      - docker/push:
          image: senzen/busservices
  deploy:
    docker:
      - image: cimg/openjdk:17.0
      - image: circleci/postgres
      environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
          POSTGRES_PASSWORD: 

    steps:
      - setup_remote_docker
      - heroku/install
      - checkout
      - run:
          name: Heroku Container Push
          command: |
            heroku container:login
            heroku container:push web -a busservices-devops
            heroku container:release web -a busservices-devops
workflows:
  simple_workflow:
    jobs:
      - build
      - test:
          requires:
            - build
      - build-and-push:
          requires:
            - test
      - deploy:
          requires:
            - build-and-push